# S-Matrix - Apache Doris 4.0 Docker Compose 配置
# 简化版本：1 FE + 1 BE 用于开发测试

services:
  # Frontend (FE) - 元数据管理和查询协调
  smatrix-fe:
    image: apache/doris:fe-4.0.0
    container_name: smatrix-fe
    hostname: smatrix-fe
    restart: always
    environment:
      - FE_SERVERS=fe1:smatrix-fe:9010
      - FE_ID=1
    ports:
      - "38030:8030"   # HTTP 端口 - Web UI
      - "39030:9030"   # MySQL 协议端口 - 客户端连接
      - "39010:9010"   # FE 内部通信端口
    volumes:
      - ./data/fe/doris-meta:/opt/apache-doris/fe/doris-meta
      - ./data/fe/log:/opt/apache-doris/fe/log
    networks:
      - smatrix-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8030/api/bootstrap"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s

  # Backend (BE) - 数据存储和查询执行
  smatrix-be:
    image: apache/doris:be-4.0.0
    container_name: smatrix-be
    hostname: smatrix-be
    restart: always
    depends_on:
      - smatrix-fe
    environment:
      - FE_SERVERS=fe1:smatrix-fe:9010
    ports:
      - "38040:8040"   # BE HTTP 端口
      - "39050:9050"   # BE 心跳端口
      - "39060:9060"   # BE Thrift 端口
    volumes:
      - ./data/be/storage:/opt/apache-doris/be/storage
      - ./data/be/log:/opt/apache-doris/be/log
    networks:
      - smatrix-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8040/api/health"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s

  # API Gateway
  smatrix-api:
    build: ./doris-api
    container_name: smatrix-api
    restart: always
    ports:
      - "38018:8000"
    networks:
      - smatrix-network
    depends_on:
      - smatrix-fe
      - smatrix-be
    environment:
      - DORIS_HOST=smatrix-fe
      - DORIS_PORT=9030
      - DORIS_USER=root
      - DORIS_PASSWORD=
      - DORIS_DATABASE=doris_db
      - DORIS_STREAM_LOAD_HOST=smatrix-be
      - DORIS_STREAM_LOAD_PORT=8040
      - DEEPSEEK_API_KEY=sk-748638f482f74b7392a6dafd89bdd307
      - DEEPSEEK_MODEL=deepseek-chat
      - DEEPSEEK_BASE_URL=https://api.deepseek.com
      # 固定加密密钥，确保密码加密一致
      - ENCRYPTION_KEY=dITsw-d5mJGd4qrPln29AldqAy8GCb4lMvvZvQGRBQU=

  # Frontend Web UI
  smatrix-frontend:
    build:
      context: ./doris-frontend
      dockerfile: Dockerfile
    container_name: smatrix-frontend
    restart: always
    ports:
      - "35173:80"
    networks:
      - smatrix-network
    depends_on:
      - smatrix-api

networks:
  smatrix-network:
    driver: bridge
